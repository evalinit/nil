const AsyncFunction=Object.getPrototypeOf(async function(){}).constructor;function random4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function generateId(){return random4()+random4()+random4()}function extractTemplates(t){var e=document.createElement("template");return e.innerHTML=t.trim(),e.content.querySelectorAll("template")}class Store{constructor(t){this._data=t=t||{},this._stage={},this._subscriptions={}}async get(t){t=t.split(".");let e=this._data;for(const s of t){if("object"!=typeof e)break;e=e[s]}return e}async set(t,e){var s=t.split(".");let n=this._data,o=s[0];var r=[];for(let t=1;t<s.length;t++){n=n[o],o=s[t];var a=s.slice(0,t).join(".");r.push(...Object.values(this._subscriptions[a]||{}))}n[o]=e,r.push(...Object.values(this._subscriptions[t]||{}));for(const c of r)Promise.resolve(c(t,e))}async delete(t){var e=t.split("."),s=e.length-1;let n=this._data,o=t;for(const r=0;r<s;r++)o=e[r],n=n[o];delete n[o]}async stage(t,e){this._stage[t]=e}async commit(){for(const e in this._stage){var t;this._stage.hasOwnProperty(e)&&(t=this._stage[e],delete this._stage[e],this.set(e,t))}}async subscribe(t,e,s){this._subscriptions.hasOwnProperty(t)||(this._subscriptions[t]={}),this._subscriptions[t][e]=s;e=await this.get(t);void 0!==e&&s(t,e)}async unsubscribe(t,e){delete this._subscriptions[t][e]}}class App{constructor(t,e,s){this.store=new Store(e),this.componentUrls=t,this.version=s,this.loadComponents()}async loadComponents(){let t;this.version?(e="components-"+this.version,(n=localStorage.getItem(e))?t=n:(t=await this.fetchTemplateStr(),localStorage.setItem(e,t))):t=await this.fetchTemplateStr();var e,s,n=extractTemplates(t);for(s of n)this.defineComponent(s)}async fetchTemplateStr(){var t=[];for(const n of this.componentUrls){var e=await fetch(n);t.push(e)}let s="";for(const o of await Promise.all(t))o.ok&&(s+=await o.text());return s}async defineComponent(s){let n=this,t="";for(const o of s.content.querySelectorAll("script"))t+=o.textContent,o.remove();const e=new AsyncFunction("self",t);customElements.define(s.id,class extends HTMLElement{static get observedAttributes(){return s.getAttributeNames()}constructor(){super();var t=this.attachShadow({mode:"open"}),e=s.content.cloneNode(!0);t.appendChild(e),this.app=n,this.componentId=generateId(),this.subscribe=async(t,e)=>{this.app.store.subscribe(t,this.componentId,e)},this.unsubsribe=async t=>{this.app.store.unsubscribe(t,this.componentId)},this.connected=!1}attributeChangedCallback(t,e,s){try{return this.handleAttributeChanged(t,e,s)}catch(t){}}connectedCallback(){this.connected||(e(this),this.connected=!0);try{return this.handleConnected()}catch(t){}}disconnectedCallback(){try{return this.handleDisconnected()}catch(t){}}adoptedCallback(){try{return this.handleAdopted()}catch(t){}}})}}export{App,Store};